# üì± QR Code Attendance System - Complete Documentation

## üåü Overview

The QR Code Attendance System provides a modern, contactless way for students to mark attendance by scanning QR codes generated by Class Representatives or Instructors. The system includes anti-fraud measures such as location verification and time-based validation to ensure authenticity.

---

## ‚ú® Key Features

### üîê Security Features
- **Encrypted QR Codes**: All QR codes contain encrypted session data
- **Time-Based Expiration**: QR codes automatically expire after session duration
- **Location Verification (Geofencing)**: Verifies student is within classroom radius
- **Anti-Spoofing Detection**: Detects fake/manipulated location data
- **One-Time Scan**: Students cannot mark attendance multiple times
- **Device Tracking**: Records device information for audit trail

### üìä Session Management
- **Unique Session IDs**: UUID-based session identification
- **Configurable Duration**: 5-120 minutes session length
- **Adjustable Radius**: 10-1000 meters geofencing radius
- **Real-Time Statistics**: Live attendance count and percentage
- **Auto-Closure**: Sessions automatically deactivate after expiration

### üë• User Experience
- **Quick Scanning**: Students scan QR code to mark attendance instantly
- **Live Updates**: CRs see real-time attendance updates
- **Attendance History**: Complete session history with filters
- **Automatic Record Creation**: Option to convert session to attendance record

---

## üèóÔ∏è Architecture

### Database Schema

#### AttendanceSession Model
```typescript
{
  _id: ObjectId,
  sessionId: string (unique, UUID),
  sectionId: ObjectId ‚Üí Section,
  courseId: ObjectId ‚Üí Course,
  date: Date,
  startTime: Date,
  endTime: Date,
  qrCode: string (base64 image),
  qrCodeData: string (encrypted),
  location?: {
    latitude: number,
    longitude: number,
    accuracy?: number,
    radius?: number
  },
  expiresAt: Date,
  isActive: boolean,
  createdBy: ObjectId ‚Üí User,
  attendedStudents: [{
    studentId: ObjectId ‚Üí Student,
    scannedAt: Date,
    location?: Location,
    deviceInfo?: string
  }],
  maxDuration: number (minutes),
  allowedRadius: number (meters),
  antiCheatEnabled: boolean,
  createdAt: Date,
  updatedAt: Date
}
```

### API Flow

```
1. CR Generates QR Session
   ‚Üì
2. System Creates Encrypted QR Code with Session Data
   ‚Üì
3. CR Displays QR Code to Students
   ‚Üì
4. Students Scan QR Code via Mobile App
   ‚Üì
5. System Validates:
   - Session still active?
   - QR code not expired?
   - Student in correct section?
   - Student not already attended?
   - Location within radius? (if enabled)
   ‚Üì
6. Mark Attendance Success
   ‚Üì
7. CR Closes Session (Optional: Generate Attendance Record)
```

---

## üìö API Endpoints

### Base URL
```
/api/qr-attendance
```

---

### 1. Generate QR Code Session

**Endpoint**: `POST /api/qr-attendance/generate`

**Access**: Admin, CR, Instructor

**Description**: Generates a new QR code session for attendance

**Request Headers**:
```
Authorization: Bearer <access_token>
Content-Type: application/json
```

**Request Body**:
```json
{
  "sectionId": "507f1f77bcf86cd799439011",
  "courseId": "507f1f77bcf86cd799439012",
  "duration": 15,
  "location": {
    "latitude": 23.8103,
    "longitude": 90.4125,
    "accuracy": 5,
    "radius": 100
  },
  "allowedRadius": 100,
  "antiCheatEnabled": true
}
```

**Request Fields**:
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `sectionId` | string | Yes | Section ID |
| `courseId` | string | Yes | Course ID |
| `duration` | number | No | Session duration in minutes (5-120, default: 15) |
| `location` | object | No | Classroom location for geofencing |
| `location.latitude` | number | Yes* | Latitude (-90 to 90) |
| `location.longitude` | number | Yes* | Longitude (-180 to 180) |
| `location.accuracy` | number | No | GPS accuracy in meters |
| `location.radius` | number | No | Allowed radius (10-1000m, default: 100) |
| `allowedRadius` | number | No | Alternative way to set radius |
| `antiCheatEnabled` | boolean | No | Enable anti-fraud checks (default: true) |

**Success Response** (201):
```json
{
  "success": true,
  "message": "QR code session generated successfully",
  "data": {
    "session": {
      "_id": "507f191e810c19729de860ea",
      "sessionId": "550e8400-e29b-41d4-a716-446655440000",
      "sectionId": {
        "_id": "507f1f77bcf86cd799439011",
        "name": "CSE-3A",
        "code": "CSE3A"
      },
      "courseId": {
        "_id": "507f1f77bcf86cd799439012",
        "name": "Software Engineering",
        "code": "CSE305"
      },
      "date": "2025-11-05T10:00:00Z",
      "startTime": "2025-11-05T10:00:00Z",
      "endTime": "2025-11-05T10:15:00Z",
      "expiresAt": "2025-11-05T10:15:00Z",
      "isActive": true,
      "maxDuration": 15,
      "allowedRadius": 100,
      "antiCheatEnabled": true,
      "attendedStudents": []
    },
    "qrCode": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUg...",
    "expiresIn": 15
  }
}
```

**Error Responses**:
- `400`: Invalid request data
- `403`: CR trying to create session for different section
- `404`: Section or course not found
- `409`: Active session already exists for this course

---

### 2. Scan QR Code (Mark Attendance)

**Endpoint**: `POST /api/qr-attendance/scan`

**Access**: All authenticated users

**Description**: Students scan QR code to mark attendance

**Request Headers**:
```
Authorization: Bearer <access_token>
Content-Type: application/json
```

**Request Body**:
```json
{
  "qrCodeData": "encrypted-qr-code-data-string",
  "studentId": "507f1f77bcf86cd799439013",
  "location": {
    "latitude": 23.8105,
    "longitude": 90.4127,
    "accuracy": 10
  },
  "deviceInfo": "iPhone 13 Pro - iOS 17.0"
}
```

**Success Response** (200):
```json
{
  "success": true,
  "message": "Attendance marked successfully!",
  "data": {
    "message": "Attendance marked successfully",
    "student": {
      "id": "507f1f77bcf86cd799439013",
      "name": "John Doe",
      "studentId": "CSE3A-001"
    },
    "session": {
      "id": "507f191e810c19729de860ea",
      "course": {
        "_id": "507f1f77bcf86cd799439012",
        "name": "Software Engineering"
      },
      "section": {
        "_id": "507f1f77bcf86cd799439011",
        "name": "CSE-3A"
      },
      "scannedAt": "2025-11-05T10:05:30Z"
    }
  }
}
```

**Error Responses**:
- `400`: Invalid QR code format or missing data
- `403`: Student not in section / Location verification failed
- `404`: Session not found or student not found
- `409`: Student already marked attendance
- `410`: QR code expired or session closed

---

### 3. Get Active Session

**Endpoint**: `GET /api/qr-attendance/active/:sectionId/:courseId`

**Access**: Admin, CR, Instructor

**Description**: Get currently active QR session for a course

**Success Response** (200):
```json
{
  "success": true,
  "message": "Active session retrieved successfully",
  "data": {
    "_id": "507f191e810c19729de860ea",
    "sessionId": "550e8400-e29b-41d4-a716-446655440000",
    "sectionId": { ... },
    "courseId": { ... },
    "isActive": true,
    "attendedStudents": [
      {
        "studentId": {
          "_id": "...",
          "studentId": "CSE3A-001",
          "name": "John Doe"
        },
        "scannedAt": "2025-11-05T10:05:30Z",
        "location": { ... }
      }
    ],
    "expiresAt": "2025-11-05T10:15:00Z"
  }
}
```

**Error Responses**:
- `403`: CR trying to access different section
- `404`: No active session found

---

### 4. Close Session

**Endpoint**: `PUT /api/qr-attendance/close/:sessionId`

**Access**: Admin, CR (creator), Instructor

**Description**: Close QR session and optionally create attendance record

**Request Body**:
```json
{
  "generateAttendanceRecord": true
}
```

**Success Response** (200):
```json
{
  "success": true,
  "message": "Session closed successfully",
  "data": {
    "session": { ... },
    "attendanceRecord": {
      "_id": "...",
      "sectionId": { ... },
      "courseId": { ... },
      "date": "2025-11-05",
      "attendees": [ ... ]
    },
    "stats": {
      "totalScanned": 45,
      "sessionDuration": 15
    }
  }
}
```

**Error Responses**:
- `400`: Session already closed
- `403`: Not authorized to close this session
- `404`: Session not found

---

### 5. Get Session Statistics

**Endpoint**: `GET /api/qr-attendance/stats/:sessionId`

**Access**: Admin, CR, Instructor

**Description**: Get real-time statistics for a session

**Success Response** (200):
```json
{
  "success": true,
  "message": "Session statistics retrieved successfully",
  "data": {
    "sessionInfo": {
      "sessionId": "550e8400-e29b-41d4-a716-446655440000",
      "course": { ... },
      "section": { ... },
      "startTime": "2025-11-05T10:00:00Z",
      "endTime": "2025-11-05T10:15:00Z",
      "isActive": true
    },
    "attendance": {
      "totalStudents": 50,
      "attendedCount": 45,
      "absentCount": 5,
      "attendanceRate": 90.00
    },
    "recentScans": [
      {
        "student": {
          "_id": "...",
          "name": "John Doe",
          "studentId": "CSE3A-001"
        },
        "scannedAt": "2025-11-05T10:14:30Z",
        "location": { ... }
      }
    ]
  }
}
```

---

### 6. Get Session History

**Endpoint**: `GET /api/qr-attendance/history`

**Access**: Admin, CR, Instructor

**Description**: Get paginated list of past QR sessions

**Query Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `sectionId` | string | Filter by section |
| `courseId` | string | Filter by course |
| `from` | date | Start date |
| `to` | date | End date |
| `page` | number | Page number (default: 1) |
| `limit` | number | Items per page (default: 10) |

**Success Response** (200):
```json
{
  "success": true,
  "message": "Session history retrieved successfully",
  "data": {
    "sessions": [ ... ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 25,
      "pages": 3
    }
  }
}
```

---

## üõ°Ô∏è Anti-Fraud Measures

### Location Verification
- **Geofencing**: Verifies student is within specified radius of classroom
- **Accuracy Buffer**: Considers GPS accuracy in distance calculation
- **Configurable Radius**: 10m to 1km based on venue type

### Anti-Spoofing Detection
1. **Impossible Speed Check**: Detects unrealistic movement between scans
2. **Accuracy Analysis**: Flags suspiciously precise coordinates
3. **Null Island Check**: Rejects (0, 0) coordinates
4. **Device Fingerprinting**: Tracks device information

### Time-Based Security
- **Session Expiration**: QR codes expire after set duration
- **Time Window Validation**: Attendance only during class time
- **One-Time Use**: Students cannot rescan same QR code

---

## üöÄ Usage Examples

### Frontend Integration (React)

#### 1. Generate QR Code (CR Dashboard)

```typescript
import { useGenerateQRSessionMutation } from '@/lib/apiSlice';

function GenerateQRButton({ sectionId, courseId }: Props) {
  const [generateQR, { isLoading }] = useGenerateQRSessionMutation();
  const [qrCode, setQRCode] = useState<string | null>(null);

  const handleGenerate = async () => {
    try {
      // Get current location
      const position = await getCurrentPosition();
      
      const result = await generateQR({
        sectionId,
        courseId,
        duration: 15,
        location: {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
        },
        allowedRadius: 100,
        antiCheatEnabled: true,
      }).unwrap();

      setQRCode(result.data.qrCode);
      toast.success('QR Code generated!');
    } catch (error) {
      toast.error('Failed to generate QR code');
    }
  };

  return (
    <div>
      <Button onClick={handleGenerate} disabled={isLoading}>
        Generate QR Code
      </Button>
      {qrCode && (
        <div className="mt-4">
          <img src={qrCode} alt="Attendance QR Code" className="w-64 h-64" />
          <p>Students have 15 minutes to scan</p>
        </div>
      )}
    </div>
  );
}
```

#### 2. Scan QR Code (Student Mobile App)

```typescript
import { Html5QrcodeScanner } from 'html5-qrcode';
import { useScanQRCodeMutation } from '@/lib/apiSlice';

function QRScanner({ studentId }: Props) {
  const [scanQR, { isLoading }] = useScanQRCodeMutation();

  const handleScan = async (qrCodeData: string) => {
    try {
      // Get current location
      const position = await getCurrentPosition();
      
      const result = await scanQR({
        qrCodeData,
        studentId,
        location: {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
        },
        deviceInfo: navigator.userAgent,
      }).unwrap();

      toast.success('Attendance marked successfully!');
    } catch (error: any) {
      toast.error(error?.data?.message || 'Failed to mark attendance');
    }
  };

  useEffect(() => {
    const scanner = new Html5QrcodeScanner('qr-reader', {
      fps: 10,
      qrbox: 250,
    }, false);

    scanner.render(handleScan, () => {});

    return () => scanner.clear();
  }, []);

  return <div id="qr-reader" />;
}
```

---

## üì± Mobile App Requirements

### Permissions Needed
- **Camera**: For QR code scanning
- **Location**: For geofencing verification
- **Internet**: For API communication

### Recommended Libraries
- **QR Scanner**: `html5-qrcode` or `react-qr-reader`
- **Geolocation**: Browser Geolocation API or `react-native-geolocation`
- **State Management**: Redux Toolkit with RTK Query

---

## ‚öôÔ∏è Configuration

### Environment Variables

Add to `.env`:
```env
# QR Code Encryption
QR_ENCRYPTION_KEY=your-32-character-secret-key!!!

# Session Defaults (optional)
QR_DEFAULT_DURATION=15
QR_DEFAULT_RADIUS=100
QR_ANTI_CHEAT_ENABLED=true
```

### Venue-Specific Radius Recommendations

```typescript
const radiusRecommendations = {
  classroom: 50,     // Small classroom
  lab: 75,           // Computer/Science lab
  auditorium: 100,   // Large auditorium
  outdoor: 200,      // Outdoor field/court
};
```

---

## üêõ Troubleshooting

### Common Issues

#### 1. "Location verification failed"
- **Cause**: Student too far from classroom
- **Solution**: Increase `allowedRadius` or disable `antiCheatEnabled`

#### 2. "QR code expired"
- **Cause**: Session duration exceeded
- **Solution**: Generate new QR code or increase `duration`

#### 3. "Student already marked attendance"
- **Cause**: Duplicate scan attempt
- **Solution**: This is expected behavior for security

#### 4. "Invalid QR code"
- **Cause**: Corrupted or tampered QR data
- **Solution**: Generate fresh QR code

---

## üéØ Best Practices

1. **Generate QR at Class Start**: Create session when class begins
2. **Display Prominently**: Show QR code on projector/board
3. **Set Reasonable Duration**: 10-15 minutes for most classes
4. **Enable Anti-Cheat**: Always use location verification
5. **Monitor Live**: Watch attendance stats in real-time
6. **Close Promptly**: Close session after scanning period
7. **Generate Record**: Convert session to attendance record

---

## üìä Analytics & Insights

### Metrics Tracked
- Total scans per session
- Attendance rate percentage
- Scan timing distribution
- Location accuracy data
- Device information
- Session duration vs. scan count

---

## üîÆ Future Enhancements

- [ ] Bluetooth beacon integration for indoor positioning
- [ ] Face recognition combined with QR scan
- [ ] Batch QR generation for multiple classes
- [ ] Offline mode with sync capability
- [ ] Advanced fraud detection with ML
- [ ] Student notifications for missed scans
- [ ] QR code customization with logos

---

## üìÑ License

This QR Code Attendance System is part of the CR Attendance Portal project.

---

<div align="center">

**Built with ‚ù§Ô∏è for Modern Education**

üì± Contactless ‚Ä¢ üîí Secure ‚Ä¢ ‚ö° Fast ‚Ä¢ üéØ Accurate

</div>
